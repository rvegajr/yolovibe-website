---
import MainLayout from '../../layouts/MainLayout.astro';
import Container from '../../components/container.astro';

// This page requires authentication - in production you'd check auth here
const title = 'Admin Dashboard - YOLOVibe';
const description = 'YOLOVibe administrative dashboard with system monitoring, usage tracking, and task management';
---

<MainLayout title={title}>
  <div class="min-h-screen bg-gradient-to-b from-gray-900 via-slate-900 to-black text-white pt-20">
    <Container>
      <div class="py-8">
      <!-- Dashboard Header -->
      <div class="mb-8">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-cyan-400">Admin Dashboard</h1>
            <p class="text-slate-300 mt-1">System overview and management</p>
          </div>
          <div class="flex items-center space-x-4">
            <div class="text-sm text-slate-400">
              Last updated: <span id="last-updated" class="text-cyan-400 font-medium">--</span>
            </div>
            <button 
              id="refresh-dashboard"
              class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-4 py-2 rounded-lg transition-all transform hover:scale-105 shadow-lg"
            >
              üîÑ Refresh
            </button>
          </div>
        </div>
      </div>

      <!-- System Status Banner -->
      <div id="system-status-banner" class="mb-6">
        <!-- Populated by JavaScript -->
      </div>

      <!-- Dashboard Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Database Usage Widget (Large) -->
        <div class="lg:col-span-2">
          <div class="bg-gradient-to-br from-slate-800/50 to-gray-800/50 rounded-2xl border border-slate-600/30 p-6 shadow-xl backdrop-blur-sm">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-2xl font-bold text-white">Database Usage</h2>
              <span id="usage-status" class="px-3 py-1 rounded-full text-sm font-medium bg-green-900/30 text-green-400 border border-green-500/30">
                SAFE
              </span>
            </div>
            
            <!-- Usage Metrics -->
            <div class="space-y-6">
              <div>
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-semibold text-slate-300">üìñ Reads</span>
                  <div class="text-right">
                    <span id="reads-count" class="text-lg font-bold text-cyan-400">--</span>
                    <div class="text-xs text-slate-400"><span id="reads-percent">--</span> of limit</div>
                  </div>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-3">
                  <div id="reads-bar" class="bg-gradient-to-r from-green-500 to-emerald-400 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
              </div>
              
              <div>
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-semibold text-slate-300">‚úçÔ∏è Writes</span>
                  <div class="text-right">
                    <span id="writes-count" class="text-lg font-bold text-blue-400">--</span>
                    <div class="text-xs text-slate-400"><span id="writes-percent">--</span> of limit</div>
                  </div>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-3">
                  <div id="writes-bar" class="bg-gradient-to-r from-blue-500 to-cyan-400 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
              </div>
              
              <div>
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-semibold text-slate-300">üíæ Storage</span>
                  <div class="text-right">
                    <span id="storage-count" class="text-lg font-bold text-purple-400">--</span>
                    <div class="text-xs text-slate-400"><span id="storage-percent">--</span> used</div>
                  </div>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-3">
                  <div id="storage-bar" class="bg-gradient-to-r from-purple-500 to-pink-400 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
              </div>
            </div>

            <!-- Usage Recommendations -->
            <div id="usage-recommendations" class="mt-4 p-3 bg-blue-50 rounded-lg hidden">
              <h4 class="text-sm font-medium text-blue-800 mb-2">üí° Optimization Recommendations</h4>
              <ul id="recommendations-list" class="text-sm text-blue-700 space-y-1">
                <!-- Populated by JavaScript -->
              </ul>
            </div>
          </div>
        </div>

        <!-- System Health Widget -->
        <div>
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">System Health</h2>
            
            <!-- Overall Status -->
            <div class="text-center mb-4">
              <div id="health-indicator" class="w-16 h-16 mx-auto rounded-full flex items-center justify-center text-2xl mb-2">
                <!-- Populated by JavaScript -->
              </div>
              <div id="health-status" class="text-lg font-medium">
                <!-- Populated by JavaScript -->
              </div>
              <div id="uptime" class="text-sm text-gray-600">
                <!-- Populated by JavaScript -->
              </div>
            </div>

            <!-- Service Checks -->
            <div id="service-checks" class="space-y-2">
              <!-- Populated by JavaScript -->
            </div>

            <!-- Performance Metrics -->
            <div class="mt-4 pt-4 border-t border-gray-200">
              <div class="grid grid-cols-2 gap-4 text-center">
                <div>
                  <div id="avg-response-time" class="text-lg font-semibold text-gray-900">--</div>
                  <div class="text-xs text-gray-600">Avg Response</div>
                </div>
                <div>
                  <div id="throughput" class="text-lg font-semibold text-gray-900">--</div>
                  <div class="text-xs text-gray-600">Requests/min</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Admin Tasks Widget -->
        <div>
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold text-gray-900">Tasks & Calendar</h2>
              <span id="overdue-badge" class="hidden bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                <!-- Populated by JavaScript -->
              </span>
            </div>
            
            <!-- Today's Tasks -->
            <div class="mb-4">
              <h3 class="text-sm font-medium text-gray-700 mb-2">Today's Tasks</h3>
              <div id="todays-tasks" class="space-y-2">
                <!-- Populated by JavaScript -->
              </div>
            </div>

            <!-- Upcoming Events -->
            <div>
              <h3 class="text-sm font-medium text-gray-700 mb-2">Upcoming Events</h3>
              <div id="upcoming-events" class="space-y-2">
                <!-- Populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>

        <!-- System Activity Widget -->
        <div>
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">System Activity</h2>
            
            <div class="grid grid-cols-2 gap-4">
              <div class="text-center">
                <div id="active-users" class="text-2xl font-bold text-blue-600">--</div>
                <div class="text-xs text-gray-600">Active Users</div>
              </div>
              <div class="text-center">
                <div id="recent-bookings" class="text-2xl font-bold text-green-600">--</div>
                <div class="text-xs text-gray-600">Recent Bookings</div>
              </div>
              <div class="text-center">
                <div id="pending-payments" class="text-2xl font-bold text-yellow-600">--</div>
                <div class="text-xs text-gray-600">Pending Payments</div>
              </div>
              <div class="text-center">
                <div id="upcoming-workshops" class="text-2xl font-bold text-purple-600">--</div>
                <div class="text-xs text-gray-600">Upcoming Workshops</div>
              </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-200">
              <div class="text-center">
                <div class="text-sm text-gray-600">Last Backup</div>
                <div id="last-backup" class="text-sm font-medium text-gray-900">--</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Events Widget -->
        <div>
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Recent Events</h2>
            
            <div id="recent-events" class="space-y-3 max-h-80 overflow-y-auto">
              <!-- Populated by JavaScript -->
            </div>
          </div>
        </div>

      </div>

      <!-- Quick Actions Footer -->
      <div class="mt-8 bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <button onclick="window.open('/admin/bookings', '_blank')" class="flex items-center justify-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
            <span class="text-blue-600">üìã Manage Bookings</span>
          </button>
          <button onclick="runUsageCheck()" class="flex items-center justify-center p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
            <span class="text-green-600">üìä Usage Report</span>
          </button>
          <button onclick="createBackup()" class="flex items-center justify-center p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
            <span class="text-purple-600">üíæ Create Backup</span>
          </button>
          <button onclick="window.open('/admin/settings', '_blank')" class="flex items-center justify-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
            <span class="text-gray-600">‚öôÔ∏è Settings</span>
          </button>
        </div>
      </div>
    </div>
  </Container>

  <script is:inline>
    // Dashboard JavaScript - Simplified for inline execution
    
    class AdminDashboard {
      constructor() {
        this.refreshInterval = 30000; // 30 seconds
        this.init();
      }

      async init() {
        try {
          // Load initial data
          await this.loadDashboardData();
          
          // Setup event listeners and auto-refresh
          this.setupEventListeners();
          this.startAutoRefresh();
          
        } catch (error) {
          console.error('Failed to initialize dashboard:', error);
          this.showError('Failed to initialize dashboard');
        }
      }

      async loadDashboardData() {
        try {
          const response = await fetch('/api/admin/dashboard');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          console.log('Dashboard data loaded:', data);
          
          // Update UI with data
          this.updateDatabaseUsage(data.databaseUsage);
          this.updateSystemStatus(data.systemStatus);
          this.updateSystemHealth(data.systemHealth);
          this.updateActivity(data.activity);
          this.updateRecentEvents(data.recentEvents);
          this.updateLastRefreshTime();
          
        } catch (error) {
          console.error('Failed to load dashboard data:', error);
          this.showError('Failed to load dashboard data: ' + error.message);
        }
      }

      updateDatabaseUsage(databaseUsage) {
        if (!databaseUsage) return;
        
        // Update metric displays
        this.updateElement('reads-count', databaseUsage.reads);
        this.updateElement('writes-count', databaseUsage.writes);
        this.updateElement('storage-count', `${databaseUsage.storage}MB`);
        
        // Update progress bars
        this.updateProgressBar('reads', (databaseUsage.reads / 10000) * 100);
        this.updateProgressBar('writes', (databaseUsage.writes / 1000) * 100);
        this.updateProgressBar('storage', databaseUsage.percentage);
        
        // Update status badge
        this.updateStatusBadge(databaseUsage.status);
      }

      updateProgressBar(type, percentage) {
        const bar = document.getElementById(`${type}-bar`);
        const percent = document.getElementById(`${type}-percent`);
        
        if (bar) {
          bar.style.width = `${Math.min(100, percentage || 0)}%`;
        }
        if (percent) {
          percent.textContent = `${(percentage || 0).toFixed(1)}%`;
        }
      }

      updateStatusBadge(status) {
        const statusEl = document.getElementById('usage-status');
        if (!statusEl) return;
        
        const statusClasses = {
          'SAFE': 'bg-green-900/30 text-green-400 border border-green-500/30',
          'WARNING': 'bg-yellow-900/30 text-yellow-400 border border-yellow-500/30',
          'CRITICAL': 'bg-red-900/30 text-red-400 border border-red-500/30'
        };
        
        statusEl.className = `px-3 py-1 rounded-full text-sm font-medium ${statusClasses[status] || statusClasses.SAFE}`;
        statusEl.textContent = status || 'SAFE';
      }

      updateSystemStatus(systemStatus) {
        const banner = document.getElementById('system-status-banner');
        if (!banner) return;
        
        if (systemStatus === 'UP') {
          banner.innerHTML = `
            <div class="p-4 rounded-lg border bg-green-900/20 border-green-500/30">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-3 h-3 bg-green-400 rounded-full mr-3 animate-pulse"></div>
                  <div>
                    <h3 class="font-semibold text-green-400">System Status: ${systemStatus}</h3>
                    <p class="text-sm text-green-300 mt-1">All systems operational</p>
                  </div>
                </div>
                <button onclick="window.dashboard.loadDashboardData()" class="text-sm text-green-400 hover:text-green-300 underline transition-colors">
                  Refresh Status
                </button>
              </div>
            </div>
          `;
        } else {
          banner.innerHTML = `
            <div class="p-4 rounded-lg border bg-red-900/20 border-red-500/30">
              <div class="flex items-center">
                <span class="text-red-400 text-lg mr-3">‚ùå</span>
                <div>
                  <h3 class="font-semibold text-red-400">System Status: ${systemStatus}</h3>
                  <p class="text-sm text-red-300 mt-1">System experiencing issues</p>
                </div>
              </div>
            </div>
          `;
        }
      }

      updateSystemHealth(systemHealth) {
        // Placeholder for system health updates
        console.log('System health:', systemHealth);
      }

      updateActivity(activity) {
        this.updateElement('active-users', activity.activeUsers);
        this.updateElement('recent-bookings', activity.recentBookings);
        this.updateElement('pending-payments', activity.pendingPayments);
        this.updateElement('upcoming-workshops', activity.upcomingWorkshops);
      }

      updateRecentEvents(events) {
        const container = document.getElementById('recent-events');
        if (!container || !events.length) return;
        
        container.innerHTML = events.slice(0, 5).map(event => {
          const typeColors = {
            'info': 'text-blue-400 bg-blue-900/20',
            'success': 'text-green-400 bg-green-900/20',
            'warning': 'text-yellow-400 bg-yellow-900/20',
            'error': 'text-red-400 bg-red-900/20'
          };
          
          const typeIcons = {
            'info': '‚ÑπÔ∏è',
            'success': '‚úÖ',
            'warning': '‚ö†Ô∏è',
            'error': '‚ùå'
          };
          
          return `
            <div class="p-3 rounded-lg ${typeColors[event.type]} border border-current border-opacity-30">
              <div class="flex items-start space-x-2">
                <span class="text-lg">${typeIcons[event.type]}</span>
                <div class="flex-1">
                  <p class="text-sm font-medium">${event.message}</p>
                  <p class="text-xs opacity-75 mt-1">${event.timestamp}</p>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      updateElement(id, value) {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
        }
      }

      updateLastRefreshTime() {
        const element = document.getElementById('last-updated');
        if (element) {
          element.textContent = new Date().toLocaleTimeString();
        }
      }

      setupEventListeners() {
        const refreshButton = document.getElementById('refresh-dashboard');
        if (refreshButton) {
          refreshButton.addEventListener('click', () => {
            this.loadDashboardData();
          });
        }
      }

      startAutoRefresh() {
        setInterval(() => {
          this.loadDashboardData();
        }, this.refreshInterval);
      }

      showError(message) {
        console.error('Dashboard Error:', message);
        // Create simple error display
        const banner = document.getElementById('system-status-banner');
        if (banner) {
          banner.innerHTML = `
            <div class="p-4 rounded-lg border bg-red-900/20 border-red-500/30">
              <div class="flex items-center">
                <span class="text-red-400 text-lg mr-3">‚ùå</span>
                <div>
                  <h3 class="font-semibold text-red-400">Dashboard Error</h3>
                  <p class="text-sm text-red-300 mt-1">${message}</p>
                </div>
              </div>
            </div>
          `;
        }
      }
    }

    // Global functions for quick actions
    window.runUsageCheck = function() {
      window.open('/admin/usage-report', '_blank');
    };

    window.createBackup = async function() {
      try {
        const response = await fetch('/api/admin/backup', { method: 'POST' });
        const result = await response.json();
        alert(`Backup created: ${result.backupId}`);
        if (window.dashboard) {
          window.dashboard.loadDashboardData();
        }
      } catch (error) {
        alert('Failed to create backup');
      }
    };

    // Initialize dashboard
    const dashboard = new AdminDashboard();
    window.dashboard = dashboard;
  </script>
      </div>
    </Container>
  </div>
</MainLayout>
        const status = document.getElementById('health-status');
        const uptime = document.getElementById('uptime');
        const checksContainer = document.getElementById('service-checks');
        
        // Update overall status
        const statusConfig = {
          healthy: { bg: 'bg-green-100', text: 'text-green-600', icon: '‚úÖ' },
          degraded: { bg: 'bg-yellow-100', text: 'text-yellow-600', icon: '‚ö†Ô∏è' },
          unhealthy: { bg: 'bg-red-100', text: 'text-red-600', icon: '‚ùå' }
        };
        
        const config = statusConfig[health.overall];
        indicator.className = `w-16 h-16 mx-auto rounded-full flex items-center justify-center text-2xl mb-2 ${config.bg}`;
        indicator.textContent = config.icon;
        status.className = `text-lg font-medium ${config.text}`;
        status.textContent = health.overall.toUpperCase();
        
        // Update uptime
        const uptimeHours = Math.floor(health.uptime / 3600);
        uptime.textContent = `Uptime: ${uptimeHours}h`;
        
        // Update service checks
        checksContainer.innerHTML = health.checks.map(check => {
          const statusIcon = check.status === 'healthy' ? 'üü¢' : 
                           check.status === 'degraded' ? 'üü°' : 'üî¥';
          return `
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-700">${statusIcon} ${check.service}</span>
              <span class="text-xs text-gray-500">${check.responseTime}ms</span>
            </div>
          `;
        }).join('');
        
        // Update performance metrics
        document.getElementById('avg-response-time').textContent = `${health.performance.avgResponseTime.toFixed(0)}ms`;
        document.getElementById('throughput').textContent = `${health.performance.throughput}`;
      }

      updateTasksWidget(tasks, events) {
        const todaysTasks = document.getElementById('todays-tasks');
        const upcomingEvents = document.getElementById('upcoming-events');
        
        // Update today's tasks
        const today = new Date().toDateString();
        const todaysTasksFiltered = tasks.filter(task => 
          new Date(task.dueDate).toDateString() === today
        );
        
        if (todaysTasksFiltered.length === 0) {
          todaysTasks.innerHTML = '<div class="text-sm text-gray-500 italic">No tasks for today</div>';
        } else {
          todaysTasks.innerHTML = todaysTasksFiltered.map(task => {
            const priorityColors = {
              urgent: 'text-red-600',
              high: 'text-orange-600',
              medium: 'text-blue-600',
              low: 'text-gray-600'
            };
            return `
              <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                <div class="flex-1">
                  <div class="text-sm font-medium ${priorityColors[task.priority]}">${task.title}</div>
                  <div class="text-xs text-gray-500">${task.type} ‚Ä¢ ${task.estimatedDuration || 15}min</div>
                </div>
                <button onclick="markTaskComplete('${task.id}')" class="text-green-600 hover:text-green-700">
                  ‚úì
                </button>
              </div>
            `;
          }).join('');
        }
        
        // Update upcoming events
        const nextEvents = events.slice(0, 3);
        if (nextEvents.length === 0) {
          upcomingEvents.innerHTML = '<div class="text-sm text-gray-500 italic">No upcoming events</div>';
        } else {
          upcomingEvents.innerHTML = nextEvents.map(event => {
            const eventDate = new Date(event.date);
            const isToday = eventDate.toDateString() === today;
            const dateStr = isToday ? 'Today' : eventDate.toLocaleDateString();
            
            return `
              <div class="p-2 bg-blue-50 rounded">
                <div class="text-sm font-medium text-blue-800">${event.title}</div>
                <div class="text-xs text-blue-600">${dateStr} ‚Ä¢ ${event.participants || 0} participants</div>
              </div>
            `;
          }).join('');
        }
      }

      updateActivityWidget(activity) {
        document.getElementById('active-users').textContent = activity.activeUsers;
        document.getElementById('recent-bookings').textContent = activity.recentBookings;
        document.getElementById('pending-payments').textContent = activity.pendingPayments;
        document.getElementById('upcoming-workshops').textContent = activity.upcomingWorkshops;
        
        const lastBackup = new Date(activity.lastBackup);
        const backupAge = Math.floor((Date.now() - lastBackup.getTime()) / (1000 * 60 * 60));
        document.getElementById('last-backup').textContent = `${backupAge}h ago`;
      }

      updateEventsWidget(events) {
        const container = document.getElementById('recent-events');
        
        if (events.length === 0) {
          container.innerHTML = '<div class="text-sm text-gray-500 italic">No recent events</div>';
          return;
        }
        
        container.innerHTML = events.map(event => {
          const severityIcons = {
            success: '‚úÖ',
            info: '‚ÑπÔ∏è',
            warning: '‚ö†Ô∏è',
            error: '‚ùå'
          };
          
          const timeAgo = this.getTimeAgo(new Date(event.timestamp));
          
          return `
            <div class="flex items-start space-x-3">
              <span class="text-lg">${severityIcons[event.severity]}</span>
              <div class="flex-1 min-w-0">
                <div class="text-sm font-medium text-gray-900">${event.message}</div>
                <div class="text-xs text-gray-500">${timeAgo}</div>
              </div>
            </div>
          `;
        }).join('');
      }

      updateSystemStatus(systemStatus) {
        const banner = document.getElementById('system-status-banner');
        
        if (systemStatus === 'UP') {
          banner.innerHTML = `
            <div class="p-4 rounded-lg border bg-green-900/20 border-green-500/30">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-3 h-3 bg-green-400 rounded-full mr-3 animate-pulse"></div>
                  <div>
                    <h3 class="font-semibold text-green-400">System Status: ${systemStatus}</h3>
                    <p class="text-sm text-green-300 mt-1">All systems operational</p>
                  </div>
                </div>
                <button onclick="dashboard.loadDashboardData()" class="text-sm text-green-400 hover:text-green-300 underline transition-colors">
                  Refresh Status
                </button>
              </div>
            </div>
          `;
        } else if (systemStatus === 'DOWN') {
          banner.innerHTML = `
            <div class="p-4 rounded-lg border bg-red-900/20 border-red-500/30">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-3 h-3 bg-red-400 rounded-full mr-3"></div>
                  <div>
                    <h3 class="font-semibold text-red-400">System Status: ${systemStatus}</h3>
                    <p class="text-sm text-red-300 mt-1">System experiencing issues</p>
                  </div>
                </div>
                <button onclick="dashboard.loadDashboardData()" class="text-sm text-red-400 hover:text-red-300 underline transition-colors">
                  Refresh Status
                </button>
              </div>
            </div>
          `;
        } else {
          banner.innerHTML = `
            <div class="p-4 rounded-lg border bg-yellow-900/20 border-yellow-500/30">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-3 h-3 bg-yellow-400 rounded-full mr-3"></div>
                  <div>
                    <h3 class="font-semibold text-yellow-400">System Status: ${systemStatus}</h3>
                    <p class="text-sm text-yellow-300 mt-1">System status degraded</p>
                  </div>
                </div>
                <button onclick="dashboard.loadDashboardData()" class="text-sm text-yellow-400 hover:text-yellow-300 underline transition-colors">
                  Refresh Status
                </button>
              </div>
            </div>
          `;
        }
      }
      }

      setupEventListeners() {
        document.getElementById('refresh-dashboard').addEventListener('click', () => {
          this.loadDashboardData();
        });
      }

      startAutoRefresh() {
        setInterval(() => {
          this.loadDashboardData();
        }, this.refreshInterval);
      }

      getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        return `${diffDays}d ago`;
      }

      showError(message) {
        // Simple error display
        console.error(message);
      }
    }

    // Global functions for quick actions
    window.markTaskComplete = async function(taskId) {
      try {
        await fetch(`/api/admin/tasks/${taskId}/complete`, { method: 'POST' });
        dashboard.loadDashboardData();
      } catch (error) {
        console.error('Failed to mark task complete:', error);
      }
    };

    window.runUsageCheck = function() {
      window.open('/admin/usage-report', '_blank');
    };

    window.createBackup = async function() {
      try {
        const response = await fetch('/api/admin/backup', { method: 'POST' });
        const result = await response.json();
        alert(`Backup created: ${result.backupId}`);
        dashboard.loadDashboardData();
      } catch (error) {
        alert('Failed to create backup');
      }
    };

    // Initialize dashboard
    const dashboard = new AdminDashboard();
    window.dashboard = dashboard;
  </script>
      </div>
    </Container>
  </div>
</MainLayout>
</Layout>