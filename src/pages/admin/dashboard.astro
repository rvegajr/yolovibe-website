---
import MainLayout from '../../layouts/MainLayout.astro';
import Container from '../../components/container.astro';

// This page requires authentication - in production you'd check auth here
const title = 'Admin Dashboard - YOLOVibe';
const description = 'YOLOVibe administrative dashboard with system monitoring, usage tracking, and task management';
---

<MainLayout title={title}>
  <div class="min-h-screen bg-gradient-to-b from-gray-900 via-slate-900 to-black text-white pt-20">
    <Container>
      <div class="py-8">
        <!-- Dashboard Header -->
        <div class="mb-8">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-cyan-400">Admin Dashboard</h1>
              <p class="text-slate-300 mt-1">System overview and management</p>
            </div>
            <div class="flex items-center space-x-4">
              <div class="text-sm text-slate-400">
               Last updated: <span id="last-updated" class="text-cyan-400 font-medium">--</span>
              </div>
              <button 
                id="refresh-dashboard"
                class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-4 py-2 rounded-lg transition-all transform hover:scale-105 shadow-lg"
              >
                üîÑ Refresh
              </button>
            </div>
          </div>
        </div>

        <!-- System Status Banner -->
        <div id="system-status-banner" class="mb-6">
          <!-- Populated by TypeScript controller -->
        </div>

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          
          <!-- Database Usage Widget (Large) -->
          <div class="lg:col-span-2">
            <div class="bg-gradient-to-br from-slate-800/50 to-gray-800/50 rounded-2xl border border-slate-600/30 p-6 shadow-xl backdrop-blur-sm">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold text-white">Database Usage</h2>
                <span id="usage-status" class="px-3 py-1 rounded-full text-sm font-medium bg-green-900/30 text-green-400 border border-green-500/30">
                  SAFE
                </span>
              </div>
              
              <!-- Usage Metrics -->
              <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="text-center">
                 <div class="text-3xl font-bold text-emerald-400" id="reads-count" data-testid="reads-count">0</div>
                  <div class="text-sm text-slate-400">Reads</div>
                  <div class="w-full bg-slate-700 rounded-full h-3 mt-2">
                    <div id="reads-bar" class="bg-gradient-to-r from-green-500 to-emerald-400 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                  </div>
                  <div class="text-xs text-slate-500 mt-1" id="reads-percent">0%</div>
                </div>
                
                <div class="text-center">
                 <div class="text-3xl font-bold text-cyan-400" id="writes-count" data-testid="writes-count">0</div>
                  <div class="text-sm text-slate-400">Writes</div>
                  <div class="w-full bg-slate-700 rounded-full h-3 mt-2">
                    <div id="writes-bar" class="bg-gradient-to-r from-blue-500 to-cyan-400 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                  </div>
                  <div class="text-xs text-slate-500 mt-1" id="writes-percent">0%</div>
                </div>
                
                <div class="text-center">
                 <div class="text-3xl font-bold text-purple-400" id="storage-count" data-testid="storage-count">0</div>
                  <div class="text-sm text-slate-400">Storage</div>
                  <div class="w-full bg-slate-700 rounded-full h-3 mt-2">
                    <div id="storage-bar" class="bg-gradient-to-r from-purple-500 to-pink-400 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                  </div>
                  <div class="text-xs text-slate-500 mt-1" id="storage-percent">0%</div>
                </div>
              </div>
            </div>
          </div>

          <!-- System Health Widget -->
          <div>
            <div class="bg-gradient-to-br from-slate-800/50 to-gray-800/50 rounded-2xl border border-slate-600/30 p-6 shadow-xl backdrop-blur-sm">
              <h2 class="text-xl font-bold text-white mb-4">System Health</h2>
              
              <div id="system-health" class="text-center">
                <div id="health-indicator" class="w-16 h-16 mx-auto rounded-full flex items-center justify-center text-2xl mb-2 bg-green-100">
                  ‚úÖ
                </div>
                <div id="health-status" class="text-lg font-medium text-green-600">Healthy</div>
                <div id="uptime" class="text-sm text-slate-400 mt-1">Uptime: --</div>
                
                <!-- Performance Metrics -->
                <div class="mt-4 space-y-2">
                  <div class="flex justify-between text-sm">
                    <span class="text-slate-400">Response Time:</span>
                    <span id="avg-response-time" class="text-white">--</span>
                  </div>
                  <div class="flex justify-between text-sm">
                    <span class="text-slate-400">Throughput:</span>
                    <span id="throughput" class="text-white">--</span>
                  </div>
                </div>

                <!-- Health Checks -->
                <div id="health-checks" class="mt-4 text-left">
                  <!-- Populated by controller -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Activity Feed and Recent Events -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
          
          <!-- Activity Feed -->
          <div class="bg-gradient-to-br from-slate-800/50 to-gray-800/50 rounded-2xl border border-slate-600/30 p-6 shadow-xl backdrop-blur-sm">
            <h2 class="text-xl font-bold text-white mb-4">Recent Activity</h2>
            <div id="activity-feed" class="space-y-2 max-h-64 overflow-y-auto">
              <!-- Populated by controller -->
            </div>
          </div>

          <!-- Recent Events -->
          <div class="bg-gradient-to-br from-slate-800/50 to-gray-800/50 rounded-2xl border border-slate-600/30 p-6 shadow-xl backdrop-blur-sm">
            <h2 class="text-xl font-bold text-white mb-4">Recent Events</h2>
            <div id="recent-events" class="space-y-2 max-h-64 overflow-y-auto">
              <!-- Populated by controller -->
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="mt-8">
          <div class="bg-gradient-to-br from-slate-800/50 to-gray-800/50 rounded-2xl border border-slate-600/30 p-6 shadow-xl backdrop-blur-sm">
            <h2 class="text-xl font-bold text-white mb-4">Quick Actions</h2>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <button onclick="window.open('/admin/bookings', '_blank')" class="flex items-center justify-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                <span class="text-blue-600 font-medium">üìä View Bookings</span>
              </button>
              <button onclick="runUsageCheck()" class="flex items-center justify-center p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                <span class="text-green-600 font-medium">‚ö° Usage Check</span>
              </button>
              <button onclick="createBackup()" class="flex items-center justify-center p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                <span class="text-purple-600 font-medium">üíæ Create Backup</span>
              </button>
              <button onclick="window.open('/admin/settings', '_blank')" class="flex items-center justify-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors">
                <span class="text-gray-600 font-medium">‚öôÔ∏è Settings</span>
              </button>
              <button onclick="window.open('/admin/consulting', '_blank')" class="flex items-center justify-center p-4 bg-teal-50 hover:bg-teal-100 rounded-lg transition-colors">
                <span class="text-teal-600 font-medium">üóìÔ∏è Consulting Availability</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </Container>
  </div>
</MainLayout>

<!-- Separate script context - no parsing conflicts -->
<script>
  import { AdminDashboard, markTaskComplete, runUsageCheck, createBackup } from '../../admin/DashboardController';
  
  // Initialize dashboard when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    // Seed initial timestamp so tests don't read "--" before data loads
    const ts = document.getElementById('last-updated');
    if (ts) ts.textContent = new Date().toLocaleString();

    const dashboard = new AdminDashboard();
    window.dashboard = dashboard;
    
    // Make utility functions globally available
    window.markTaskComplete = markTaskComplete;
    window.runUsageCheck = runUsageCheck;
    window.createBackup = createBackup;
  });
</script> 